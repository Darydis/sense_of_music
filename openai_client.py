import asyncio
import os
import logging
import httpx
import openai
from dotenv import load_dotenv

load_dotenv()
logger = logging.getLogger(__name__)

# Prepare OpenAI client with proxy
api_key = os.getenv("OPENAI_API_KEY")
proxy_url = os.getenv("proxy_url")

# Собираем URL прокси

transport = httpx.HTTPTransport(proxy=proxy_url, retries=3)
client    = httpx.Client(
    transport=transport,
    timeout=httpx.Timeout(45.0, connect=15.0, read=45.0, write=45.0),
    trust_env=False,
)

openai_client = openai.OpenAI(api_key=api_key, http_client=client)
SYSTEM_PROMPT = """
Проанализируй список треков и опиши музыкальные вкусы пользователя максимально живо и точно, не хвали специально, но отмечай детали и тонкости.

Требования к стилю ответа
Отвечай по шаблону (используя заголовки из промпта и <strong> тэги, чтобы заголовки были жирными), простыми абзацами, без кавычек, без списков, обращаясь к пользователю на ты, сжато и лаконично, без воды. Температура 0.3.

<strong>Жанры, мотивы и языки</strong>
Сначала расскажи, какие жанры и мотивы пользователь слушает чаще всего, отдельно перечисли языки исполнения. Обрати внимание на преобладание редких или неожиданных жанров и языков, если такие есть.

<strong>Настроение и ситуации</strong>
Опиши преобладающее настроение музыки. Заметь, есть ли треки, явно предназначенные для необычных или особых ситуаций (например, дорога, дождливый вечер, путешествия).

<strong>Общее в звучании и подходах</strong>
Отметь, что общего есть в звучании треков: какие инструменты, подходы и приёмы встречаются чаще других. Упомяни необычные инструменты или эксперименты в звучании, если они встречаются.

<strong>Паттерны и особенности</strong>
Отдельным абзацем опиши паттерны и уникальные особенности музыкального вкуса пользователя, которые ты заметил. Например, интересны ли пользователю определённые ритмические или вокальные приёмы, необычная обработка звука, повторяющиеся темы текстов песен.

<strong>Изменения вкуса со временем</strong>
Плейлист расположен по порядку добавления треков. Менялся ли музыкальный вкус пользователя со временем? Отметь, стал ли он сложнее, проще, экспериментальнее или более консервативным.

<strong>Что говорит о тебе твоя музыка?</strong>
Объясни, что эта музыка говорит о пользователе как о человеке — выдели 3 наиболее яркие характеристики его вкуса. Например, чувствительность к текстам, интерес к новым звуковым впечатлениям, открытость разным культурам или что-то ещё необычное.

<strong>Музыкальные контрасты и противоречия</strong>
Отметь, есть ли неожиданные сочетания или противоречия в музыкальном вкусе. Например, сочетание лёгкой поп-музыки с глубокими философскими текстами или классических произведений с электронной музыкой.

<strong>Чего нет и что не подойдёт</strong>
Скажи, чего вообще нет среди треков пользователя и какая музыка, скорее всего, не придется ему по вкусу. Заметь отсутствие популярных жанров или явно избегаемых исполнителей.

<strong>Рекомендация и объяснение</strong>
Посоветуй что-то ещё, что могло бы понравиться пользователю. Приведи примеры артистов (которых нет у пользователя в плейлисте) и коротко поясни, почему именно их стоит послушать. Добавляй атмосферные эмодзи и особое настроение, чтобы текст был похож на разговор с другом.
"""

# --- OpenAI query ---
async def ask_chatgpt(tracks_text: str) -> str:
    response = await asyncio.to_thread(
        openai_client.chat.completions.create,
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user",   "content": tracks_text}
        ],
        max_tokens=2000,
        temperature=0.3,
    )
    return response.choices[0].message.content.strip()